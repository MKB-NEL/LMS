<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Laptop Management System for managing student records and usage analytics.">
    <title>Laptop Management System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js for Dashboard Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.min.js"></script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .sidebar { width: 250px; height: 100vh; position: fixed; top: 0; left: 0; transition: transform 0.3s ease; z-index: 1000; }
        .sidebar.collapsed { transform: translateX(-250px); }
        .main-content { margin-left: 250px; transition: margin-left 0.3s ease; }
        .main-content.full-width { margin-left: 0; }
        .status-in { background-color: #28a745; color: white; }
        .status-out { background-color: #dc3545; color: white; }
        .status-quarantined { background-color: #dc3545; color: white; }
        .loading-spinner { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .loading-spinner.show { display: flex; }
        .spinner { width: 3rem; height: 3rem; border: 0.35rem solid rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .custom-time-input { display: flex; gap: 10px; }
        .custom-time-input input { flex: 1; }
        @media (max-width: 768px) {
            .sidebar { width: 200px; }
            .sidebar.collapsed { transform: translateX(-200px); }
            .main-content { margin-left: 0; }
            .main-content.full-width { margin-left: 0; }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar" class="sidebar bg-dark text-white">
        <div class="p-4">
            <h3 class="h4 mb-4 text-white d-flex align-items-center">
                <i class="fas fa-laptop me-2"></i> LMS
            </h3>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a href="#" class="nav-link text-white active" onclick="showSection('dashboardSection')" aria-label="Dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link text-white" onclick="showSection('addStudentSection')" aria-label="Add Student">
                        <i class="fas fa-user-plus me-2"></i> Add Student
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link text-white" onclick="showSection('recordsSection')" aria-label="Student Records">
                        <i class="fas fa-list-ul me-2"></i> Student Records
                    </a>
                </li>
                <li class="nav-item mt-4">
                    <a href="#" class="nav-link text-white" id="themeToggle" aria-label="Toggle Theme">
                        <i class="fas fa-moon me-2"></i> Toggle Theme
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link text-white" onclick="signOut()" aria-label="Sign Out">
                        <i class="fas fa-sign-out-alt me-2"></i> Sign Out
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="bg-white shadow-sm p-3 d-flex justify-content-between align-items-center">
            <button id="sidebarToggle" class="btn btn-outline-primary" aria-label="Toggle Sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <div class="d-flex align-items-center">
                <div class="input-group me-3" style="width: 200px;">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input id="searchInput" type="text" class="form-control" placeholder="Search..." aria-label="Search records">
                </div>
                <div class="d-flex align-items-center">
                    <div id="userAvatar" class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">?</div>
                    <span id="userRole" class="ms-2 d-none d-md-inline">Admin</span>
                </div>
            </div>
        </header>

        <!-- Main Sections -->
        <main class="p-4">
            <!-- Dashboard Section -->
            <section id="dashboardSection" class="fade-in">
                <h2 class="h3 mb-4">Dashboard</h2>
                <div id="notifications" class="mb-4"></div>
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Total Students</p>
                                        <h3 id="totalStudents" class="mb-0">0</h3>
                                    </div>
                                    <i class="fas fa-users text-primary fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Checked Out</p>
                                        <h3 id="checkedOut" class="mb-0">0</h3>
                                    </div>
                                    <i class="fas fa-laptop text-danger fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Daily Usage</p>
                                        <h3 id="dailyUsageTime" class="mb-0">0</h3>
                                        <p class="text-muted small">hours today</p>
                                    </div>
                                    <i class="fas fa-clock text-success fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Most Used Brand</p>
                                        <h3 id="mostUsedBrand" class="mb-0">-</h3>
                                    </div>
                                    <i class="fas fa-laptop-code text-purple fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-4 mt-4">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h4 class="card-title">Weekly Usage</h4>
                                <canvas id="weeklyUsageChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h4 class="card-title">Daily Total Usage</h4>
                                <canvas id="dailyTotalUsageChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-4">
                    <div class="card-body">
                        <h4 class="card-title">Recent Activity</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Action</th>
                                        <th>Time</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivity"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Add Student Section -->
            <section id="addStudentSection" class="fade-in d-none">
                <h2 class="h3 mb-4">Add New Student</h2>
                <div class="card">
                    <div class="card-body">
                        <form id="studentForm" novalidate>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="studentName" class="form-label">Student Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input id="studentName" type="text" class="form-control" placeholder="Full name" required>
                                    </div>
                                    <div id="studentNameFeedback" class="invalid-feedback">Name is required.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="studentClass" class="form-label">Class Combination</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-graduation-cap"></i></span>
                                        <select id="studentClass" class="form-select" required>
                                            <option value="" disabled selected>Select Class</option>
                                            <option value="S4MCE">S4MCE</option><option value="S4MEG">S4MEG</option><option value="S4PCB">S4PCB</option>
                                            <option value="S4PCM">S4PCM</option><option value="S4MCB">S4MCB</option><option value="S4LFK">S4LFK</option>
                                            <option value="S5MCE">S5MCE</option><option value="S5MEG">S5MEG</option><option value="S5PCB">S5PCB</option>
                                            <option value="S5PCM">S5PCM</option><option value="S5MCB">S5MCB</option><option value="S5LFK">S5LFK</option>
                                            <option value="S6MCE">S6MCE</option><option value="S6MEG">S6MEG</option><option value="S6PCB">S6PCB</option>
                                            <option value="S6PCM">S6PCM</option><option value="S6MCB">S6MCB</option><option value="S6LFK">S6LFK</option>
                                        </select>
                                    </div>
                                    <div id="studentClassFeedback" class="invalid-feedback">Class is required.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="computerBrand" class="form-label">Computer Brand & Charger</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-laptop"></i></span>
                                        <input id="computerBrand" type="text" class="form-control" placeholder="e.g., Dell XPS 13" required>
                                    </div>
                                    <div id="computerBrandFeedback" class="invalid-feedback">Brand is required.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="serialNumber" class="form-label">Serial Number</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                        <input id="serialNumber" type="text" class="form-control" placeholder="Device serial number">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea id="description" class="form-control" rows="3" placeholder="Any special notes about the device"></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="additionalEquipment" class="form-label">Additional Equipment</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-headphones"></i></span>
                                        <input id="additionalEquipment" type="text" class="form-control" placeholder="e.g., headphones, mouse, etc.">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="csvImport" class="form-label">Import CSV</label>
                                    <input id="csvImport" type="file" accept=".csv" class="form-control">
                                    <div id="csvImportFeedback" class="invalid-feedback">Please select a valid CSV file.</div>
                                </div>
                            </div>
                            <div class="mt-4 d-flex justify-content-end gap-2">
                                <button type="reset" class="btn btn-outline-secondary">Clear</button>
                                <button type="submit" class="btn btn-primary">Add Student</button>
                                <button type="button" onclick="importCSV()" class="btn btn-success">Import CSV</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Records Section -->
            <section id="recordsSection" class="fade-in d-none">
                <h2 class="h3 mb-4">Student Records</h2>
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <select id="classFilter" class="form-select" style="width: 150px;" aria-label="Filter by class">
                                <option value="">All Classes</option>
                                <option value="S4MCE">S4MCE</option><option value="S4MEG">S4MEG</option><option value="S4PCB">S4PCB</option>
                                <option value="S4PCM">S4PCM</option><option value="S4MCB">S4MCB</option><option value="S4LFK">S4LFK</option>
                                <option value="S5MCE">S5MCE</option><option value="S5MEG">S5MEG</option><option value="S5PCB">S5PCB</option>
                                <option value="S5PCM">S5PCM</option><option value="S5MCB">S5MCB</option><option value="S5LFK">S5LFK</option>
                                <option value="S6MCE">S6MCE</option><option value="S6MEG">S6MEG</option><option value="S6PCB">S6PCB</option>
                                <option value="S6PCM">S6PCM</option><option value="S6MCB">S6MCB</option><option value="S6LFK">S6LFK</option>
                            </select>
                            <select id="statusFilter" class="form-select" style="width: 150px;" aria-label="Filter by status">
                                <option value="">All Status</option>
                                <option value="in">Available</option>
                                <option value="out">Checked Out</option>
                                <option value="quarantined">Quarantined</option>
                            </select>
                            <button onclick="exportCSV()" class="btn btn-outline-primary">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" aria-label="Select all records"></th>
                                        <th>Student</th>
                                        <th>Class</th>
                                        <th>Device</th>
                                        <th>Status</th>
                                        <th>Last Activity</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recordsList"></tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                Showing <span id="recordsStart">1</span> to <span id="recordsEnd">10</span> of <span id="recordsTotal">0</span> entries
                            </div>
                            <div>
                                <button class="btn btn-outline-primary" id="prevPage" disabled>Previous</button>
                                <button class="btn btn-outline-primary" id="nextPage" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-dark text-white text-center py-4 mt-4">
            <p>Â© <span id="currentYear"></span> Laptop Management System. All rights reserved.</p>
            <p class="small mb-0">Made with <i class="fas fa-heart text-danger"></i> by <a href="https://myportfolio-orpin.vercel.app/" target="_blank" class="text-primary text-decoration-none">M.K.Bertrand</a> | CEO of btem@fficial</p>
        </footer>
    </div>

    <!-- Modals -->
    <!-- Checkout Options Modal -->
    <div class="modal fade" id="checkoutOptionsModal" tabindex="-1" aria-labelledby="checkoutOptionsModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkoutOptionsModalTitle">Checkout Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="lendTo" class="form-label">Lend To (Optional)</label>
                        <input type="text" id="lendTo" class="form-control" placeholder="Student borrowing the laptop">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Return Time (Optional)</label>
                        <div class="custom-time-input">
                            <input type="time" id="customReturnTime" class="form-control" placeholder="HH:MM">
                            <select id="customReturnPeriod" class="form-select" style="width: 150px;">
                                <option value="today">Today</option>
                                <option value="1">1 Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                                <option value="7">1 Week</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="skipCheckoutOptions" onclick="skipCheckoutOptions()">Skip</button>
                    <button type="button" class="btn btn-primary" id="continueCheckout" onclick="continueCheckout()">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quarantine Modal -->
    <div class="modal fade" id="quarantineModal" tabindex="-1" aria-labelledby="quarantineModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quarantineModalTitle">Quarantine Student Device</h5>
                    <button type="button" class="btn-close" onclick="closeModal('quarantineModal')" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="quarantinePeriod" class="form-label">Select Quarantine Period</label>
                    <select id="quarantinePeriod" class="form-select">
                        <option value="2">2 Days</option>
                        <option value="5">5 Days</option>
                        <option value="7">1 Week</option>
                        <option value="14">2 Weeks</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quarantineModal')">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="applyQuarantine()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Set Time Modal -->
    <div class="modal fade" id="setTimeModal" tabindex="-1" aria-labelledby="setTimeModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setTimeModalTitle">Set Return Time</h5>
                    <button type="button" class="btn-close" onclick="closeModal('setTimeModal')" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="returnDay" class="form-label">Select Day</label>
                        <select id="returnDay" class="form-select">
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <div>
                        <label for="returnTime" class="form-label">Select Time</label>
                        <select id="returnTime" class="form-select">
                            <option value="08:00">08:00 AM</option><option value="09:00">09:00 AM</option>
                            <option value="10:00">10:00 AM</option><option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option><option value="13:00">01:00 PM</option>
                            <option value="14:00">02:00 PM</option><option value="15:00">03:00 PM</option>
                            <option value="16:00">04:00 PM</option><option value="17:00">05:00 PM</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('setTimeModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyReturnTime()">Set Time</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="modalStudentName" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalStudentName">Student Name</h5>
                    <button type="button" class="btn-close" onclick="closeModal('studentDetailsModal')" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Class:</strong> <span id="modalStudentClass">-</span></p>
                            <p><strong>Device:</strong> <span id="modalDevice">-</span></p>
                            <p><strong>Serial:</strong> <span id="modalSerial">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> <span id="modalStatus" class="status-badge">-</span></p>
                            <p><strong>Return Time:</strong> <span id="modalReturnTime">-</span></p>
                            <p><strong>Total Usage:</strong> <span id="modalTotalUsage">-</span></p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p><strong>Additional Equipment:</strong> <span id="modalAdditionalEquipment">None</span></p>
                    </div>
                    <div class="mt-3">
                        <p><strong>Notes:</strong></p>
                        <p id="modalDescription">No notes available</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="modalActionButton" class="btn btn-primary"></button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('studentDetailsModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Module Script: Firebase and Core Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAAEYQGHXf7t5VgI9MkXO1RpiCH5w98GPw",
            authDomain: "laptopms.firebaseapp.com",
            projectId: "laptopms",
            storageBucket: "laptopms.appspot.com",
            messagingSenderId: "965071744622",
            appId: "1:965071744622:web:3411e7f0700f",
            measurementId: "G-2TCX"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('Firebase initialized successfully');
        } catch (err) {
            console.error('Firebase initialization failed:', err);
            alert('Failed to initialize Firebase.');
        }

        // Global State
        window.records = [];
        window.currentModalIndex = -1;
        window.usageStats = {};
        window.currentCheckoutIndex = -1;

        // Utility Functions
        function sanitizeInput(input) {
            if (!input) return '';
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        window.sanitizeInput = sanitizeInput; // Expose globally

        function getWeekNumber(timestamp) {
            const date = new Date(timestamp);
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7) + 1;
        }

        function getNextDayDate(day, time) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const now = new Date();
            const targetDay = days.indexOf(day);
            let currentDay = now.getDay();
            let daysToAdd = (targetDay - currentDay + 7) % 7;
            if (daysToAdd === 0) daysToAdd = 7;
            const returnDate = new Date(now);
            returnDate.setDate(now.getDate() + daysToAdd);
            const [hours, minutes] = time.split(':').map(Number);
            returnDate.setHours(hours, minutes, 0, 0);
            return returnDate;
        }

        function showSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.classList.add('show');
        }

        function hideSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.classList.remove('show');
        }

        async function logError(message, error) {
            console.error(message, error);
            try {
                if (auth?.currentUser) {
                    await setDoc(doc(db, 'users', auth.currentUser.uid, 'error_logs', Date.now().toString()), {
                        message,
                        error: error.message,
                        timestamp: new Date().toISOString()
                    });
                }
            } catch (err) {
                console.error('Error logging error:', err);
            }
        }

        async function logAction(uid, action, details) {
            try {
                await setDoc(doc(db, 'users', uid, 'audit_logs', Date.now().toString()), {
                    action,
                    details,
                    timestamp: new Date().toISOString(),
                    by: auth.currentUser?.email || 'system'
                });
            } catch (err) {
                logError('Action logging error', err);
            }
        }

        // Authentication
        if (auth) {
            showSpinner();
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        const userData = userDoc.exists() ? userDoc.data() : {};
                        const userRole = userData.role || 'Teacher';
                        document.getElementById('userAvatar').textContent = userData.name ? userData.name.charAt(0) : 'U';
                        document.getElementById('userRole').textContent = userRole;
                        loadRecords(user.uid);
                        loadUsageStats(user.uid);
                        window.showSection(userRole === 'Teacher' ? 'addStudentSection' : 'dashboardSection');
                    } catch (err) {
                        logError('User data error', err);
                        alert('Error loading user data');
                    } finally {
                        hideSpinner();
                    }
                }
            }, (err) => {
                logError('Auth state error', err);
                hideSpinner();
                alert('Authentication error');
            });
        }

        // Load Records
        function loadRecords(userId) {
            if (!db) return;
            showSpinner();
            const recordsRef = collection(db, 'users', userId, 'records');
            onSnapshot(recordsRef, (snapshot) => {
                window.records = [];
                snapshot.forEach(doc => window.records.push({ id: doc.id, ...doc.data() }));
                window.updateRecordsList();
                window.checkQuarantineStatus();
                window.checkOverdueReturns();
                window.updateDashboard();
                hideSpinner();
            }, (err) => {
                logError('Load records error', err);
                alert('Error loading records');
                hideSpinner();
            });
        }

        // Load Usage Stats
        function loadUsageStats(userId) {
            if (!db) return;
            showSpinner();
            onSnapshot(collection(db, 'users', userId, 'usage_stats'), (snapshot) => {
                window.usageStats = {};
                snapshot.forEach(doc => {
                    window.usageStats[doc.id] = doc.data();
                });
                window.updateDashboard();
                hideSpinner();
            }, (err) => {
                logError('Load usage stats error', err);
                alert('Error loading analytics');
                hideSpinner();
            });
        }

        // Add Student
        window.addStudent = async () => {
            const studentForm = document.getElementById('studentForm');
            if (!studentForm) return;

            ['studentNameFeedback', 'studentClassFeedback', 'computerBrandFeedback'].forEach(id => {
                document.getElementById(id)?.classList.remove('d-block');
            });

            if (!studentForm.checkValidity()) {
                studentForm.classList.add('was-validated');
                if (!document.getElementById('studentName').value.trim()) document.getElementById('studentNameFeedback')?.classList.add('d-block');
                if (!document.getElementById('studentClass').value) document.getElementById('studentClassFeedback')?.classList.add('d-block');
                if (!document.getElementById('computerBrand').value.trim()) document.getElementById('computerBrandFeedback')?.classList.add('d-block');
                return;
            }

            const studentName = sanitizeInput(document.getElementById('studentName').value.trim());
            const studentClass = document.getElementById('studentClass').value;
            const computerBrand = sanitizeInput(document.getElementById('computerBrand').value.trim());
            const serialNumber = sanitizeInput(document.getElementById('serialNumber').value.trim());
            const description = sanitizeInput(document.getElementById('description').value.trim());
            const additionalEquipment = sanitizeInput(document.getElementById('additionalEquipment').value.trim());

            showSpinner();
            try {
                const user = auth.currentUser;
                const record = {
                    studentName,
                    studentClass,
                    computerBrand,
                    serialNumber,
                    description,
                    additionalEquipment,
                    status: 'in',
                    checkoutTime: null,
                    returnTime: null,
                    quarantineEnd: null,
                    overdue: false,
                    history: [],
                    createdAt: new Date().toISOString(),
                };
                await setDoc(doc(collection(db, 'users', user.uid, 'records')), record);
                await logAction(user.uid, 'add_student', { studentName, studentClass });
                studentForm.reset();
                studentForm.classList.remove('was-validated');
                window.showSection('recordsSection');
            } catch (err) {
                logError('Add student error', err);
                alert('Error adding student');
            } finally {
                hideSpinner();
            }
        };

        // Check Out with Options
        window.showCheckoutOptions = function(index) {
            window.currentCheckoutIndex = index;
            const modal = new bootstrap.Modal(document.getElementById('checkoutOptionsModal'));
            document.getElementById('lendTo').value = '';
            document.getElementById('customReturnTime').value = '';
            document.getElementById('customReturnPeriod').value = 'today';
            modal.show();
        };

        window.skipCheckoutOptions = function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('checkoutOptionsModal'));
            modal.hide();
            window.checkOut(window.currentCheckoutIndex, null, null);
        };

        window.continueCheckout = function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('checkoutOptionsModal'));
            const lendTo = document.getElementById('lendTo').value.trim();
            const returnTime = document.getElementById('customReturnTime').value;
            const returnPeriod = document.getElementById('customReturnPeriod').value;

            // Calculate return date based on options
            let returnDate = null;
            if (returnTime && returnPeriod) {
                const now = new Date();
                returnDate = new Date(now);

                if (returnPeriod === 'today') {
                    returnDate.setHours(returnTime.split(':')[0], returnTime.split(':')[1], 0, 0);
                } else {
                    const days = parseInt(returnPeriod);
                    returnDate.setDate(now.getDate() + days);
                    returnDate.setHours(returnTime.split(':')[0], returnTime.split(':')[1], 0, 0);
                }
            }

            modal.hide();
            window.checkOut(window.currentCheckoutIndex, lendTo, returnDate);
        };

        // Check Out
        window.checkOut = async (index, lendTo, returnDate) => {
            const record = window.records[index];
            if (!record || !db) return;
            if (record.status === 'quarantined') {
                alert('Device is quarantined until ' + new Date(record.quarantineEnd).toLocaleString());
                return;
            }
            if (record.status !== 'in') return;

            showSpinner();
            try {
                const user = auth.currentUser;
                const checkoutTime = new Date().toISOString();
                
                record.status = 'out';
                record.checkoutTime = checkoutTime;
                record.returnTime = returnDate ? returnDate.toISOString() : null;
                
                const actionDetails = {
                    action: 'checkout', 
                    time: checkoutTime, 
                    by: user.email
                };
                
                if (lendTo) {
                    actionDetails.lendTo = lendTo;
                }
                
                record.history.unshift(actionDetails);
                
                await setDoc(doc(db, 'users', user.uid, 'records', record.id), record);
                await logAction(user.uid, 'checkout', { 
                    studentName: record.studentName,
                    lendTo,
                    returnTime: returnDate?.toISOString()
                });
                window.currentCheckoutIndex = -1;
            } catch (err) {
                logError('Checkout error', err);
                alert('Error checking out');
            } finally {
                hideSpinner();
            }
        };

        // Check In
        window.checkIn = async (index) => {
            const record = window.records[index];
            if (!record || !db || record.status !== 'out') return;

            showSpinner();
            try {
                const user = auth.currentUser;
                const checkinTime = new Date();
                const duration = ((checkinTime - new Date(record.checkoutTime)) / (1000 * 3600)).toFixed(2);
                record.status = 'in';
                record.checkoutTime = null;
                record.returnTime = null;
                record.overdue = false;
                record.history.unshift({ 
                    action: 'checkin', 
                    time: checkinTime.toISOString(), 
                    duration, 
                    by: user.email 
                });
                await setDoc(doc(db, 'users', user.uid, 'records', record.id), record);
                await logAction(user.uid, 'checkin', { 
                    studentName: record.studentName, 
                    duration 
                });
            } catch (err) {
                logError('Checkin error', err);
                alert('Error checking in');
            } finally {
                hideSpinner();
            }
        };

        // Apply Quarantine
        window.applyQuarantine = async () => {
            if (window.currentModalIndex < 0 || !db) return;
            const record = window.records[window.currentModalIndex];
            if (!record) return;
            const period = parseInt(document.getElementById('quarantinePeriod')?.value);
            if (!period) return;

            showSpinner();
            try {
                const user = auth.currentUser;
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + period);
                record.status = 'quarantined';
                record.quarantineEnd = endDate.toISOString();
                record.history.unshift({ 
                    action: 'quarantine', 
                    time: new Date().toISOString(), 
                    period, 
                    endDate: endDate.toISOString(), 
                    by: user.email 
                });
                await setDoc(doc(db, 'users', user.uid, 'records', record.id), record);
                await logAction(user.uid, 'quarantine', { 
                    studentName: record.studentName, 
                    period 
                });
                window.closeModal('quarantineModal');
            } catch (err) {
                logError('Quarantine error', err);
                alert('Error applying quarantine');
            } finally {
                hideSpinner();
            }
        };

        // Apply Return Time
        window.applyReturnTime = async () => {
            if (window.currentModalIndex < 0 || !db) return;
            const record = window.records[window.currentModalIndex];
            if (!record) return;
            const day = document.getElementById('returnDay')?.value;
            const time = document.getElementById('returnTime')?.value;
            if (!day || !time) return;

            showSpinner();
            try {
                const user = auth.currentUser;
                const returnDate = getNextDayDate(day, time);
                record.returnTime = returnDate.toISOString();
                record.overdue = false;
                record.history.unshift({ 
                    action: 'set_return_time', 
                    time: new Date().toISOString(), 
                    returnTime: returnDate.toISOString(), 
                    by: user.email 
                });
                await setDoc(doc(db, 'users', user.uid, 'records', record.id), record);
                await logAction(user.uid, 'set_return_time', { 
                    studentName: record.studentName, 
                    returnTime: returnDate.toISOString() 
                });
                window.closeModal('setTimeModal');
            } catch (err) {
                logError('Set return time error', err);
                alert('Error setting return time');
            } finally {
                hideSpinner();
            }
        };

        // Check Quarantine Status
        window.checkQuarantineStatus = () => {
            if (!db) return;
            const now = Date.now();
            const batch = writeBatch(db);
            let hasUpdates = false;

            window.records.forEach(record => {
                if (record.status === 'quarantined' && record.quarantineEnd && new Date(record.quarantineEnd).getTime() <= now) {
                    record.status = 'in';
                    record.quarantineEnd = null;
                    record.history.unshift({ action: 'quarantine_end', time: new Date().toISOString(), by: 'system' });
                    batch.set(doc(db, 'users', auth.currentUser.uid, 'records', record.id), record);
                    hasUpdates = true;
                }
            });

            if (hasUpdates) {
                batch.commit().catch(err => logError('Quarantine update error', err));
            }
        };

        // Check Overdue Returns
        window.checkOverdueReturns = () => {
            if (!db) return;
            const now = Date.now();
            const batch = writeBatch(db);
            let hasUpdates = false;

            window.records.forEach(record => {
                if (record.status === 'out' && record.returnTime && new Date(record.returnTime).getTime() < now && !record.overdue) {
                    record.overdue = true;
                    record.history.unshift({ action: 'overdue', time: new Date().toISOString(), by: 'system' });
                    batch.set(doc(db, 'users', auth.currentUser.uid, 'records', record.id), record);
                    hasUpdates = true;
                }
            });

            if (hasUpdates) {
                batch.commit().catch(err => logError('Overdue update error', err));
            }
        };

        // Export CSV
        window.exportCSV = () => {
            if (!window.records.length) {
                alert('No records to export');
                return;
            }

            const headers = ['Student Name', 'Class', 'Device', 'Serial Number', 'Status', 'Checkout Time', 'Return Time', 'Additional Equipment', 'Description'];
            const rows = window.records.map(record => [
                `"${sanitizeInput(record.studentName)}"`,
                record.studentClass,
                `"${sanitizeInput(record.computerBrand)}"`,
                `"${sanitizeInput(record.serialNumber || '')}"`,
                record.status,
                record.checkoutTime ? new Date(record.checkoutTime).toLocaleString() : '',
                record.returnTime ? new Date(record.returnTime).toLocaleString() : '',
                `"${sanitizeInput(record.additionalEquipment || '')}"`,
                `"${sanitizeInput(record.description || '')}"`
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `records-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        };

        // Import CSV (Placeholder)
        window.importCSV = () => {
            alert('CSV import functionality is not implemented yet.');
        };

        // Sign Out
        window.signOut = async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (err) {
                logError('Sign out error', err);
                alert('Error signing out');
            }
        };
    </script>

    <!-- Non-Module Script: UI Interactions -->
    <script>
        console.log('UI script loaded');

        window.currentPage = 1;
        const recordsPerPage = 10;
        let weeklyUsageChart = null;
        let dailyUsageChart = null;

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Show Section
        window.showSection = function(sectionId) {
            ['dashboardSection', 'addStudentSection', 'recordsSection'].forEach(id => {
                const section = document.getElementById(id);
                if (section) section.classList.add('d-none');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('d-none');
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                document.querySelector(`a[onclick="showSection('${sectionId}')"]`)?.classList.add('active');
            }
        };

        // Close Modal
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const modalInstance = bootstrap.Modal.getInstance(modal) || new bootstrap.Modal(modal);
                modalInstance.hide();
            }
            window.currentModalIndex = -1;
        };

        // Open Modal
        window.openModal = function(modalId, index) {
            window.currentModalIndex = index;
            const modal = document.getElementById(modalId);
            if (modal) {
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
            }
        };

        // Show Student Details
        window.showStudentDetails = function(index) {
            window.currentModalIndex = index;
            const record = window.records[index];
            if (!record) return;

            document.getElementById('modalStudentName').textContent = window.sanitizeInput(record.studentName);
            document.getElementById('modalStudentClass').textContent = record.studentClass;
            document.getElementById('modalDevice').textContent = window.sanitizeInput(record.computerBrand);
            document.getElementById('modalSerial').textContent = record.serialNumber || '-';
            const statusEl = document.getElementById('modalStatus');
            if (statusEl) {
                statusEl.textContent = record.status.charAt(0).toUpperCase() + record.status.slice(1);
                statusEl.className = 'status-badge ' + (record.status === 'in' ? 'status-in' : record.status === 'out' ? 'status-out' : 'status-quarantined');
            }
            document.getElementById('modalReturnTime').textContent = record.returnTime ? new Date(record.returnTime).toLocaleString() : '-';
            const totalUsage = record.history.reduce((sum, h) => sum + (parseFloat(h.duration) || 0), 0);
            document.getElementById('modalTotalUsage').textContent = totalUsage.toFixed(2) + ' hours';
            document.getElementById('modalAdditionalEquipment').textContent = record.additionalEquipment || 'None';
            document.getElementById('modalDescription').textContent = record.description || 'No notes available';

            const actionButton = document.getElementById('modalActionButton');
            if (actionButton) {
                actionButton.textContent = record.status === 'in' ? 'Check Out' : 'Check In';
                actionButton.onclick = () => record.status === 'in' ? window.showCheckoutOptions(index) : window.checkIn(index);
            }

            window.openModal('studentDetailsModal', index);
        };

        // Update Records List
        window.updateRecordsList = function() {
            const recordsList = document.getElementById('recordsList');
            if (!recordsList) return;

            const searchInput = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const classFilter = document.getElementById('classFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';

            let filteredRecords = window.records.filter(record => {
                const matchesSearch = record.studentName.toLowerCase().includes(searchInput) ||
                                      record.computerBrand.toLowerCase().includes(searchInput) ||
                                      (record.serialNumber && record.serialNumber.toLowerCase().includes(searchInput));
                const matchesClass = !classFilter || record.studentClass === classFilter;
                const matchesStatus = !statusFilter || record.status === statusFilter;
                return matchesSearch && matchesClass && matchesStatus;
            });

            // Sort by last activity (most recent first)
            filteredRecords.sort((a, b) => {
                const timeA = a.history?.length ? new Date(a.history[0].time).getTime() : 0;
                const timeB = b.history?.length ? new Date(b.history[0].time).getTime() : 0;
                return timeB - timeA;
            });

            const totalRecords = filteredRecords.length;
            const start = (window.currentPage - 1) * recordsPerPage;
            const end = Math.min(start + recordsPerPage, totalRecords);
            filteredRecords = filteredRecords.slice(start, end);

            recordsList.innerHTML = '';
            filteredRecords.forEach((record, index) => {
                const globalIndex = start + index;
                const statusClass = record.status === 'in' ? 'status-in' :
                                    record.status === 'out' ? 'status-out' : 'status-quarantined';
                const lastActivity = record.history?.length ? new Date(record.history[0].time).toLocaleString() : '-';
                
                // Find if this record was lent to someone else
                const latestLend = record.history?.find(h => h.action === 'checkout' && h.lendTo);
                const lendBadge = latestLend ? `<span class="badge bg-warning text-dark ms-2">Lent to ${window.sanitizeInput(latestLend.lendTo)}</span>` : '';

                recordsList.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="record-checkbox" data-index="${globalIndex}"></td>
                        <td>${window.sanitizeInput(record.studentName)}${lendBadge}</td>
                        <td>${record.studentClass}</td>
                        <td>${window.sanitizeInput(record.computerBrand)}</td>
                        <td><span class="status-badge ${statusClass}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</span></td>
                        <td>${lastActivity}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="window.showStudentDetails(${globalIndex})" aria-label="View details"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-success ms-1" onclick="window.${record.status === 'in' ? 'showCheckoutOptions' : 'checkIn'}(${globalIndex})" aria-label="${record.status === 'in' ? 'Check out' : 'Check in'}">
                                <i class="fas ${record.status === 'in' ? 'fa-sign-out-alt' : 'fa-sign-in-alt'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="window.openModal('quarantineModal', ${globalIndex})" aria-label="Quarantine"><i class="fas fa-ban"></i></button>
                            ${record.status === 'out' ? `<button class="btn btn-sm btn-outline-warning ms-1" onclick="window.openModal('setTimeModal', ${globalIndex})" aria-label="Set return time"><i class="fas fa-clock"></i></button>` : ''}
                        </td>
                    </tr>
                `;
            });

            document.getElementById('recordsStart').textContent = totalRecords ? start + 1 : 0;
            document.getElementById('recordsEnd').textContent = end;
            document.getElementById('recordsTotal').textContent = totalRecords;
            document.getElementById('prevPage').disabled = window.currentPage === 1;
            document.getElementById('nextPage').disabled = end >= totalRecords;
        };

        // Update Dashboard
        window.updateDashboard = function() {
            if (!window.records) {
                console.warn('No records available to update dashboard');
                return;
            }

            // Metrics
            document.getElementById('totalStudents').textContent = window.records.length;
            document.getElementById('checkedOut').textContent = window.records.filter(r => r.status === 'out').length;

            // Calculate daily usage
            const today = new Date().toISOString().split('T')[0];
            let dailyUsage = 0;
            window.records.forEach(record => {
                if (record.status === 'out' && record.checkoutTime) {
                    const checkoutDate = new Date(record.checkoutTime).toISOString().split('T')[0];
                    if (checkoutDate === today) {
                        const duration = (new Date() - new Date(record.checkoutTime)) / (1000 * 3600);
                        dailyUsage += duration;
                    }
                }
            });
            document.getElementById('dailyUsageTime').textContent = dailyUsage.toFixed(2);

            // Calculate most used brand
            const brandCounts = window.records.reduce((acc, r) => {
                acc[r.computerBrand] = (acc[r.computerBrand] || 0) + 1;
                return acc;
            }, {});
            const mostUsedBrand = Object.keys(brandCounts).sort((a, b) => brandCounts[b] - brandCounts[a])[0] || '-';
            document.getElementById('mostUsedBrand').textContent = mostUsedBrand;

            // Recent Activity
            const recentActivity = document.getElementById('recentActivity');
            if (recentActivity) {
                const activities = [];
                window.records.forEach(record => {
                    if (record.history) {
                        record.history.slice(0, 5).forEach(h => {
                            activities.push({
                                studentName: record.studentName,
                                action: h.action,
                                time: h.time,
                                duration: h.duration || null
                            });
                        });
                    }
                });
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));
                recentActivity.innerHTML = activities.slice(0, 5).map(a => `
                    <tr>
                        <td>${window.sanitizeInput(a.studentName)}</td>
                        <td>${a.action.charAt(0).toUpperCase() + a.action.slice(1)}</td>
                        <td>${new Date(a.time).toLocaleString()}</td>
                        <td>${a.duration ? a.duration + ' hours' : '-'}</td>
                    </tr>
                `).join('');
            }

            // Charts
            const weeklyUsageCtx = document.getElementById('weeklyUsageChart')?.getContext('2d');
            if (weeklyUsageCtx) {
                const weeks = Array.from({ length: 4 }, (_, i) => `Week ${i + 1}`);
                const weeklyData = Array.from({ length: 4 }, (_, i) => {
                    // For demo, generate random data if no usage stats available
                    if (!window.usageStats) return Math.random() * 10 + 5;
                    const weekNum = getWeekNumber(new Date().getTime()) - i;
                    return window.usageStats[`week_${weekNum}`]?.totalHours || 0;
                }).reverse();
                
                if (!weeklyUsageChart) {
                    weeklyUsageChart = new Chart(weeklyUsageCtx, {
                        type: 'line',
                        data: {
                            labels: weeks,
                            datasets: [{
                                label: 'Weekly Usage (hours)',
                                data: weeklyData,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { 
                                    beginAtZero: true, 
                                    title: { 
                                        display: true, 
                                        text: 'Hours' 
                                    } 
                                }
                            }
                        }
                    });
                } else {
                    weeklyUsageChart.data.datasets[0].data = weeklyData;
                    weeklyUsageChart.update();
                }
            }

            const dailyUsageCtx = document.getElementById('dailyTotalUsageChart')?.getContext('2d');
            if (dailyUsageCtx) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const last7Days = Array.from({ length: 7 }, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();
                
                // Calculate daily usage from records if no usage stats available
                const dailyData = last7Days.map(date => {
                    if (!window.records) return 0;
                    return window.records.reduce((total, record) => {
                        if (!record.history) return total;
                        
                        // Sum all checkin actions for this date that have duration
                        return total + record.history.reduce((sum, h) => {
                            if (h.action === 'checkin' && h.time && h.time.includes(date) && h.duration) {
                                return sum + parseFloat(h.duration);
                            }
                            return sum;
                        }, 0);
                    }, 0);
                });

                if (!dailyUsageChart) {
                    dailyUsageChart = new Chart(dailyUsageCtx, {
                        type: 'bar',
                        data: {
                            labels: days,
                            datasets: [{
                                label: 'Daily Usage (hours)',
                                data: dailyData,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { 
                                    beginAtZero: true, 
                                    title: { 
                                        display: true, 
                                        text: 'Hours' 
                                    } 
                                }
                            }
                        }
                    });
                } else {
                    dailyUsageChart.data.datasets[0].data = dailyData;
                    dailyUsageChart.update();
                }
            }
        };

        // Setup UI Listeners
        function setupUIListeners() {
            // Sidebar Toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            if (sidebarToggle && sidebar && mainContent) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('full-width');
                });
            }

            // Theme Toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('bg-dark');
                    document.body.classList.toggle('bg-light');
                    document.body.classList.toggle('text-white');
                    document.querySelectorAll('.card').forEach(card => {
                        card.classList.toggle('bg-dark');
                        card.classList.toggle('text-white');
                    });
                    localStorage.setItem('theme', document.body.classList.contains('bg-dark') ? 'dark' : 'light');
                });
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('bg-dark', 'text-white');
                    document.querySelectorAll('.card').forEach(card => card.classList.add('bg-dark', 'text-white'));
                }
            }

            // Search and Filters
            document.getElementById('searchInput')?.addEventListener('input', () => {
                window.currentPage = 1;
                window.updateRecordsList();
            });
            document.getElementById('classFilter')?.addEventListener('change', () => {
                window.currentPage = 1;
                window.updateRecordsList();
            });
            document.getElementById('statusFilter')?.addEventListener('change', () => {
                window.currentPage = 1;
                window.updateRecordsList();
            });

            // Pagination
            document.getElementById('prevPage')?.addEventListener('click', () => {
                if (window.currentPage > 1) {
                    window.currentPage--;
                    window.updateRecordsList();
                }
            });
            document.getElementById('nextPage')?.addEventListener('click', () => {
                window.currentPage++;
                window.updateRecordsList();
            });

            // Student Form Submission
            const studentForm = document.getElementById('studentForm');
            if (studentForm) {
                studentForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    window.addStudent();
                });
            }

            // Select All Checkbox
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                selectAll.addEventListener('change', () => {
                    document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = selectAll.checked);
                });
            }
        }

        // Initialize UI
        document.addEventListener('DOMContentLoaded', () => {
            setupUIListeners();
            // Initialize dashboard with empty data
            window.updateDashboard();
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
